# 数据生成评估框架

## 核心评估维度

基于数据合成领域的标准定义，本系统采用**两个核心评估维度**：

### 1. 忠实度 (Faithfulness)

**定义**：合成的数据其内容是否正确无误，是否有事实性错误或者错误的标签或者无关内容。

#### 评估内容

| 检查项 | 说明 | 示例 |
|--------|------|------|
| **事实性错误** | 违反物理规律或业务逻辑 | 入口时间晚于交易时间、优惠费大于应付费 |
| **标签错误** | 分类或标注不正确 | 客车标记为3轴、货车重量超限150% |
| **路段-日期映射错误** | 与真实采样日期不符 | 麻文高速数据不在2023-01-03 |
| **字段完整性** | 缺少必填字段 | 缺少车型、交易时间等关键字段 |

#### 评分标准

```python
忠实度得分 = 完全正确的样本数 / 总样本数

# 样本被判定为"完全正确"的条件：
- 业务规则检查得分 ≥ 0.8
- 无路段-日期映射错误
```

#### 输出示例

```json
{
  "score": 0.95,
  "valid_count": 95,
  "total_count": 100,
  "section_date_errors": 2,
  "common_issues": {
    "时间错误": 1,
    "费用错误": 2,
    "路段日期映射错误": 2
  }
}
```

---

### 2. 多样性 (Diversity)

**定义**：为了避免学习时候过度拟合，数据在指令和回复方面都希望具有多种不同的描述。

#### 评估内容

| 维度 | 说明 | 目的 |
|------|------|------|
| **词汇多样性** | 车型、门架、路段、时段的不同值数量 | 确保覆盖各种场景 |
| **样本独特性** | 检查重复样本的比例 | 避免学习到重复模式 |
| **分布覆盖度** | 是否覆盖目标分布中的所有类别 | 确保各类别有足够样本 |

#### 评分标准

```python
多样性得分 = (
    车型多样性 * 0.20 +
    门架多样性 * 0.25 +
    路段多样性 * 0.20 +
    时段多样性 * 0.15 +
    样本独特性 * 0.20
)

# 各项计算：
- 车型多样性 = min(唯一车型数 / 10, 1.0)
- 门架多样性 = min(唯一门架数 / 30, 1.0)
- 路段多样性 = min(唯一路段数 / 8, 1.0)
- 时段多样性 = min(唯一时段数 / 4, 1.0)
- 样本独特性 = 不重复样本数 / 总样本数
```

#### 输出示例

```json
{
  "score": 0.87,
  "unique_values": {
    "vehicle_type": 8,
    "gantry_id": 45,
    "section_id": 7,
    "time_period": 4
  },
  "uniqueness": 1.0,
  "coverage": 1.0
}
```

---

## 综合评分

```python
综合得分 = 忠实度 * 0.6 + 多样性 * 0.4
```

**权重说明**：
- **忠实度权重更高（60%）**：确保生成数据的正确性是首要任务
- **多样性权重（40%）**：在保证正确的基础上，追求多样性以避免过拟合

---

## 为什么没有"分布匹配"？

在早期版本中，系统有独立的"分布匹配"评估维度。经过重新审视标准定义后，我们将其**整合到现有维度中**：

| 原"分布匹配"的内容 | 归属维度 | 原因 |
|-------------------|----------|------|
| 车辆类型比例 | **多样性** - 分布覆盖度 | 确保有足够的货车和客车样本，避免过拟合 |
| 路段-日期对应 | **忠实度** - 事实性错误 | 错误的日期是"事实性错误" |
| 时段分布 | **多样性** - 词汇多样性 | 确保覆盖不同时段，避免过拟合 |

这样的整合使评估体系更加**简洁和标准化**。

---

## 评估流程

```
生成样本
   ↓
[忠实度评估]
   ├─ 业务规则检查 (SampleFilter)
   ├─ 路段-日期映射检查
   └─ 计算合格样本比例
   ↓
[多样性评估]
   ├─ 统计唯一值数量
   ├─ 计算样本独特性
   ├─ 检查分布覆盖度
   └─ 综合计算多样性得分
   ↓
[综合评分]
   └─ 加权平均（忠实度60% + 多样性40%）
```

---

## 使用示例

### Python API

```python
from dgm_gantry_generator import DGMGantryGenerator

# 创建生成器
generator = DGMGantryGenerator()

# 生成数据
result = generator.generate(count=100)

# 查看评估结果
print(f"忠实度: {result['evaluation']['faithfulness']['score']:.2%}")
print(f"多样性: {result['evaluation']['diversity']['score']:.2%}")
print(f"综合得分: {result['evaluation']['overall_score']:.2%}")

# 详细信息
faith = result['evaluation']['faithfulness']
print(f"合格样本: {faith['valid_count']}/{faith['total_count']}")
print(f"路段日期错误: {faith['section_date_errors']}个")

div = result['evaluation']['diversity']
print(f"唯一车型数: {div['unique_values']['vehicle_type']}")
print(f"样本独特性: {div['uniqueness']:.2%}")
```

### 命令行输出

```
[阶段 III] Evaluation - 数据评估
----------------------------------------
  [直接评估]
    忠实度: 95.00%
    多样性: 87.00%
    综合得分: 91.80%
```

### 详细报告

```
============================================================
评估报告
============================================================

综合得分: 91.80%

[直接评估]
  忠实度: 95.00% (95/100 合格)
    - 路段日期映射错误: 2 个
    - 常见问题: {'时间错误': 1, '费用错误': 2}
  
  多样性: 87.00%
    - 唯一车型数: 8
    - 唯一门架ID数: 45
    - 唯一路段ID数: 7
    - 唯一时段数: 4
    - 样本独特性: 100.00%
    - 分布覆盖度: 100.00%

[间接评估]
  异常检测任务: 精确率 85.00%
  费用预测任务: 准确率 92.00%
```

---

## 路段-日期映射验证

作为**忠实度评估**的重要组成部分，系统会验证每个路段的数据是否在正确的日期生成：

```python
预配置的路段-日期映射：
- 麻文高速 (G5615530120): 2023-01-03
- 都香高速 (G7611530010): 2023-02-01
- 彝良至昭通高速 (S0010530010): 2023-02-20~21
- ...
```

如果生成的数据违反了这个映射（如麻文高速的数据出现在2023-02-01），将被标记为**事实性错误**。

---

## 改进历史

### v2.0 - 标准化重构（当前版本）

**改进**：
- ✅ 移除"分布匹配"作为独立维度
- ✅ 整合到忠实度和多样性中
- ✅ 新增路段-日期映射验证
- ✅ 新增时段多样性评估
- ✅ 新增分布覆盖度评估
- ✅ 明确权重：忠实度60% + 多样性40%

**依据**：
- 忠实度定义：检查事实性错误、错误标签、无关内容
- 多样性定义：确保数据多样性，避免过拟合

### v1.0 - 初始版本

**指标**：
- 忠实度：业务规则检查
- 多样性：唯一值统计
- 分布匹配：JS散度计算（已移除）

---

## 参考

本评估框架基于数据合成领域的标准定义，确保生成的数据既**正确无误**（忠实度），又**多样丰富**（多样性），从而为下游任务提供高质量的训练数据。
